<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout}">

<head>
    <script th:src="@{/js/ckeditor.js}"></script>
</head>

<th:block layout:fragment="css">
    <style>
        .ck.ck-editor__main>.ck-editor__editable:not(.ck-focused){
            border: none;
        }
        .ck.ck-editor__editable.ck-blurred .ck-widget.ck-widget_selected, .ck.ck-editor__editable.ck-blurred .ck-widget.ck-widget_selected:hover{
            outline: none;
        }
    </style>
</th:block>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        let errMsg = [[${errMsg}]];

        if(errMsg){
            alert(errMsg);
        }

        //포스트 삭제
        function deletePost(){
            let token = $("meta[name='_csrf']").attr("content");
            let header = $("meta[name='_csrf_header']").attr("content");

            let url = "/blog/" + [[${postDTO.postId}]]

            $.ajax({
                url:url,
                type: "DELETE",
                beforeSend: function (xhr){
                    xhr.setRequestHeader(header,token);
                },
                dataType: "json",
                cache: false,
                success: function (result, status){
                    alert("삭제가 완료되었습니다.");
                    location.href = '/blog/list';
                },
                error: function (jqXHR, status, error){
                    alert(jqXHR.responseText);
                    location.href = '/blog/list';
                }
            });
        }

        //댓글 쓰기
        function writeComment(){
            let token = $("meta[name='_csrf']").attr("content");
            let header = $("meta[name='_csrf_header']").attr("content");
            let content = $("#content").val();
            let postId = [[${postDTO.postId}]];

            let writeData = {content: content, postId: postId};

            $.ajax({
                url: '/comment',
                type: 'POST',
                beforeSend: function (xhr){
                    xhr.setRequestHeader(header,token);
                },
                data: JSON.stringify(writeData),
                contentType: "application/json; charset=utf-8",
                dataType: "JSON",

                success:function (result){
                    alert("포스트 작성이 완료되었습니다.");
                },
                error: function (jqXHR, status, error){
                    alert(jqXHR.responseText);
                }
            });
        }

        $(document).ready(function (){
           $('#post-delete').click(function (){
              deletePost();
           });

        });

    </script>
</th:block>

<div layout:fragment="content">
    <div id="post-area">
        <span class="badge badge-secondary float-right" th:if="${postDTO.categoryDTO != null}" th:text="${postDTO.categoryDTO.name}"></span>
        <span class="badge badge-secondary float-right" th:unless="${postDTO.categoryDTO != null}">미분류</span>

        <!-- Title -->
        <h1 class="mt-4" th:text="${postDTO.title}"></h1>
        <h5 class="text-muted" th:text="${postDTO.hook_text}"></h5>

        <!-- 작성자 -->
        <p class="lead">
            by <a href="#" th:text="${postDTO.writer}"></a>
        </p>

        <hr/>

        <!-- 포스트 삭제 버튼 -->
        <a id="post-delete" sec:authorize="isAuthenticated()" th:if="${#authentication.principal.Nick == postDTO.writer}" class="btn btn-danger btn-sm float-right ml-1" role="button">
            <i class="fas fa-trash"></i> 포스트 삭제
        </a>

        <!-- 포스트 수정 버튼 -->
        <a sec:authorize="isAuthenticated()" th:if="${#authentication.principal.Nick == postDTO.writer}" class="btn btn-info btn-sm float-right" th:href="@{/admin/editPost(postId=${postDTO.postId})}" role="button">
            <i class="fas fa-pen"></i> 포스트 수정
        </a>



        <!-- 작성날짜 -->
        <p th:text="'Posted on ' + ${postDTO.postDate}"></p>

        <hr />

        <!--헤드 이미지-->
        <img class="img-fluid rounded" th:if="${postDTO.headImgUrl != null}" th:src="${postDTO.headImgUrl}" />
        <img class="img-fluid rounded" th:unless="${postDTO.headImgUrl != null}" th:src="'https://picsum.photos/seed/' + ${postDTO.postId} + '/800/200'" />
        <hr />

        <!-- 본문 -->
        <textarea class="editor" th:text="${postDTO.content}"></textarea>
        <br /><br />

        <!-- 태그영역 -->
        <th:block th:if="${postDTO.tags != null}">
            <i class="fas fa-tags"></i>
            <th:block th:each="tag:${postDTO.tags}">
                <a th:href="@{/blog/search(type='tag', searchWord=${tag})}">
                    <span class="badge badge-pill badge-light" th:text="${tag}"></span>
                </a>
            </th:block>
            <br /><br />
        </th:block>

        <!-- 첨부파일 -->
        <a th:href="@{/ajax/fileDownload(url=${postDTO.attachedFileUrl}, orgFileName=${postDTO.attachedFileName})}" th:if="${postDTO.attachedFileUrl != null}" class="btn btn-outline-dark" role="button" download>
            <i class="fa fa-file"></i> [[${postDTO.attachedFileName}]]
        </a>
        <hr />
    </div>

    <!-- 댓글창 -->
    <div id="comment-area">
        <div class="card my-4">
            <h5 class="card-header">Leave a Comment:</h5>
            <div class="card-body">
                <div sec:authorize="isAuthenticated()" id="comment-box">
                    <div class="form-group">
                        <textarea name="content" cols="40" rows="5" class="form-control" id="content" required></textarea>
                    </div>
                    <button onclick="writeComment()" class="btn btn-primary">작성</button>
                </div>

                <a sec:authorize="isAnonymous()" role="button" class="btn btn-outline-dark btn-block btn-sm" href="#" data-toggle="modal" data-target="#loginModal">
                    댓글을 쓰려면 로그인 하세요
                </a>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        ClassicEditor
            .create( document.querySelector( '.editor' ), {
                licenseKey: '',
            } )
            .then( editor => {
                const toolbarElement = editor.ui.view.toolbar.element;

                editor.enableReadOnlyMode(editor.id);
                toolbarElement.style.display = 'none';

                window.editor = editor;

            } )
            .catch( error => {
                console.error( 'Oops, something went wrong!' );
                console.error( 'Please, report the following error on https://github.com/ckeditor/ckeditor5/issues with the build id and the error stack trace:' );
                console.warn( 'Build id: bs03ogvipfit-mir5mhpvo533' );
                console.error( error );
            } );
    </script>

</div>

</html>