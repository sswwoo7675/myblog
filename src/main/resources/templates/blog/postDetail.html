<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <script th:src="@{/js/ckeditor.js}"></script>
</head>

<th:block layout:fragment="css">
    <style>
        .ck.ck-editor__main>.ck-editor__editable:not(.ck-focused){
            border: none;
        }
        .ck.ck-editor__editable.ck-blurred .ck-widget.ck-widget_selected, .ck.ck-editor__editable.ck-blurred .ck-widget.ck-widget_selected:hover{
            outline: none;
        }
    </style>
</th:block>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        let errMsg = [[${errMsg}]];

        if(errMsg){
            alert(errMsg);
        }

        $(document).ready(function (){
           $('#post-delete').click(function (){
              deletePost();
           });

            function deletePost(){
                let token = $("meta[name='_csrf']").attr("content");
                let header = $("meta[name='_csrf_header']").attr("content");

                let url = "/blog/" + [[${postDTO.postId}]]

                $.ajax({
                    url:url,
                    type: "DELETE",
                    beforeSend: function (xhr){
                        xhr.setRequestHeader(header,token);
                    },
                    dataType: "json",
                    cache: false,
                    success: function (result, status){
                        alert("삭제가 완료되었습니다.");
                        location.href = '/blog/list';
                    },
                    error: function (jqXHR, status, error){
                        if(jqXHR.status == 401){
                            alert(jqXHR.responseText);
                            location.href = '/blog/list';
                        } else {
                            alert(jqXHR.responseText);
                            location.href = '/blog/list';
                        }
                    }
                });
            }
        });

    </script>
</th:block>

<div layout:fragment="content">
    <div id="post-area">
        <span class="badge badge-secondary float-right" th:if="${postDTO.categoryDTO != null}" th:text="${postDTO.categoryDTO.name}"></span>
        <span class="badge badge-secondary float-right" th:unless="${postDTO.categoryDTO != null}">미분류</span>

        <!-- Title -->
        <h1 class="mt-4" th:text="${postDTO.title}"></h1>
        <h5 class="text-muted" th:text="${postDTO.hook_text}"></h5>

        <!-- 작성자 -->
        <p class="lead">
            by <a href="#" th:text="${postDTO.writer}"></a>
        </p>

        <hr/>

        <!-- 포스트 삭제 버튼 -->
        <a id="post-delete" sec:authorize="isAuthenticated()" th:if="${#authentication.principal.Nick == postDTO.writer}" class="btn btn-danger btn-sm float-right ml-1" role="button">
            <i class="fas fa-trash"></i> 포스트 삭제
        </a>

        <!-- 포스트 수정 버튼 -->
        <a sec:authorize="isAuthenticated()" th:if="${#authentication.principal.Nick == postDTO.writer}" class="btn btn-info btn-sm float-right" th:href="@{/admin/editPost(postId=${postDTO.postId})}" role="button">
            <i class="fas fa-pen"></i> 포스트 수정
        </a>



        <!-- 작성날짜 -->
        <p th:text="'Posted on ' + ${postDTO.postDate}"></p>

        <hr />

        <!--헤드 이미지-->
        <img class="img-fluid rounded" th:if="${postDTO.headImgUrl != null}" th:src="${postDTO.headImgUrl}" />
        <img class="img-fluid rounded" th:unless="${postDTO.headImgUrl != null}" th:src="'https://picsum.photos/seed/' + ${postDTO.postId} + '/800/200'" />
        <hr />

        <!-- 본문 -->
        <textarea class="editor" th:text="${postDTO.content}"></textarea>
        <br /><br />

        <!-- 태그영역 -->
        <th:block th:if="${postDTO.tags != null}">
            <i class="fas fa-tags"></i>
            <th:block th:each="tag:${postDTO.tags}">
                <a href="#">
                    <span class="badge badge-pill badge-light" th:text="${tag}"></span>
                </a>
            </th:block>
            <br /><br />
        </th:block>

        <!-- 첨부파일 -->
        <a th:href="@{/ajax/fileDownload(url=${postDTO.attachedFileUrl}, orgFileName=${postDTO.attachedFileName})}" th:if="${postDTO.attachedFileUrl != null}" class="btn btn-outline-dark" role="button" download>
            <i class="fa fa-file"></i> [[${postDTO.attachedFileName}]]
        </a>
        <hr />
    </div>

    <!-- 댓글창 -->
    <div id="comment-area">

    </div>

    <script th:inline="javascript">
        ClassicEditor
            .create( document.querySelector( '.editor' ), {
                licenseKey: '',
            } )
            .then( editor => {
                const toolbarElement = editor.ui.view.toolbar.element;

                editor.enableReadOnlyMode(editor.id);
                toolbarElement.style.display = 'none';

                window.editor = editor;

            } )
            .catch( error => {
                console.error( 'Oops, something went wrong!' );
                console.error( 'Please, report the following error on https://github.com/ckeditor/ckeditor5/issues with the build id and the error stack trace:' );
                console.warn( 'Build id: bs03ogvipfit-mir5mhpvo533' );
                console.error( error );
            } );
    </script>

</div>

</html>